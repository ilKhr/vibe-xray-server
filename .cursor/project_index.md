# Проект: Xray Reality CLI Manager

## Общее описание
Это CLI-приложение на Python для управления Xray-core с протоколом REALITY. Приложение позволяет настраивать конфигурацию Xray, запускать и останавливать Xray через Docker, управлять пользователями и генерировать QR-коды с конфигурацией для клиентов.

## Архитектура
Приложение разделено на несколько модулей:
- `main.py` - точка входа, обработка аргументов командной строки
- `config_manager.py` - управление конфигурацией Xray
- `user_manager.py` - управление пользователями
- `docker_manager.py` - управление Docker-контейнером с Xray

## Ключевые компоненты

### ConfigManager
- Управляет конфигурацией Xray
- Создает базовую конфигурацию с REALITY
- Генерирует ключи для REALITY
- Обновляет отдельные параметры конфигурации
- Сохраняет и загружает конфигурацию из файлов
- Управляет shortIds для пользователей (добавление и удаление)
- Поддерживает перезапуск сервера после сохранения конфигурации

### UserManager
- Добавляет и удаляет пользователей
- Генерирует UUID для пользователей
- Генерирует и назначает индивидуальные shortId каждому пользователю
- Удаляет shortId при удалении пользователя
- Создает QR-коды с конфигурацией
- Отображает QR-коды прямо в терминале (ASCII) или сохраняет в файлы PNG
- Генерирует JSON-конфигурацию для клиентов
- Создает URI-ссылки VLESS для быстрой настройки клиентов
- Генерирует QR-коды для URI-ссылок VLESS
- Автоматически определяет внешний IP-адрес сервера

### DockerManager
- Запускает и останавливает контейнер Docker с Xray
- Монтирует файл конфигурации в контейнер
- Предоставляет функцию перезапуска контейнера без полной остановки и запуска

## Основные команды

### config
- Создает или обновляет конфигурацию Xray
- Поддерживает частичное обновление параметров
- Параметры: `--dest`, `--server-names`, `--port`, `--save`, `--restart`

### gen-keys
- Генерирует ключи X25519 для REALITY
- Может сохранять ключи в существующую конфигурацию
- Параметры: `--save-to-config`, `--restart`

### start
- Запускает контейнер Docker с Xray
- Монтирует конфигурацию в контейнер
- Параметры: `--config`, `--detach`

### stop
- Останавливает контейнер Docker с Xray

### add-user
- Добавляет пользователя в конфигурацию
- Генерирует UUID и индивидуальный shortId для пользователя
- Параметры: `--name`, `--config`, `--restart`

### remove-user
- Удаляет пользователя из конфигурации
- Удаляет shortId из списка shortIds в конфигурации
- Параметры: `--name`, `--config`, `--restart`

### list-users
- Выводит список всех пользователей
- Параметры: `--config`

### qr
- Генерирует QR-код с конфигурацией для клиента
- Отображает QR-код в терминале (ASCII) если не указан параметр `--save`
- Сохраняет QR-код в файл PNG, если указан параметр `--save`
- Параметры: `--name`, `--config`, `--save`

### get-config
- Выводит JSON-конфигурацию для клиента без генерации QR-кода
- Может выводить конфигурацию в терминал или сохранять в файл
- Параметры: `--name`, `--config`, `--save`

### vless-link
- Генерирует URI-ссылку VLESS для быстрой настройки клиента
- Автоматически определяет внешний IP-адрес сервера, если не указан явно
- Может включать IP-адрес или домен сервера в ссылку (явно указанный через `--server`)
- Поддерживает вывод в терминал или сохранение в файл
- Может генерировать QR-код на основе VLESS-ссылки (ASCII в терминале или PNG-файл)
- Параметры: `--name`, `--config`, `--server`, `--save`, `--qr`, `--qr-save`

## Технические особенности REALITY

REALITY - усовершенствование протокола TLS:
- Реализует полный TLS 1.3 с определенным SNI веб-сайта для маскировки
- Использует X25519 для обмена ключами
- Не требует настройки TLS сервера или покупки домена
- Может указывать чужие сайты в качестве маскировки
- Устойчив к атакам на цепочку сертификатов

## Структура конфигурации

### Базовая структура
```json
{
  "log": {
    "loglevel": "warning"
  },
  "inbounds": [
    {
      "listen": "0.0.0.0",
      "port": 443,
      "protocol": "vless",
      "settings": {
        "clients": [],
        "decryption": "none"
      },
      "streamSettings": {
        "network": "tcp",
        "security": "reality",
        "realitySettings": {
          "dest": "example.com:443",
          "serverNames": ["example.com", "www.example.com"],
          "privateKey": "приватный_ключ",
          "shortIds": []  // Список shortIds для всех пользователей
        }
      },
      "sniffing": {
        "enabled": true,
        "destOverride": ["http", "tls", "quic"]
      }
    }
  ],
  "outbounds": [
    {
      "protocol": "freedom",
      "tag": "direct"
    },
    {
      "protocol": "blackhole",
      "tag": "block"
    }
  ]
}
```

### Метаданные пользователей
Метаданные хранятся в отдельном файле `*_metadata.json`:
```json
{
  "server": {
    "publicKey": "публичный_ключ",
    "serverName": "example.com",
    "dest": "example.com:443",
    "port": 443
  },
  "users": {
    "uuid": {
      "name": "username",
      "shortId": "индивидуальный_short_id_пользователя",
      "data": {
        // Данные пользователя для QR-кода
      }
    }
  }
}
```

## Особенности реализации

### Индивидуальные shortId
- Каждый пользователь получает уникальный shortId при создании
- ShortId добавляется в список shortIds в realitySettings
- При удалении пользователя его shortId также удаляется из конфигурации
- ShortId для каждого пользователя хранится в метаданных

### Автоматический перезапуск сервера
- Опциональный перезапуск сервера после изменения конфигурации
- Поддерживается для команд `config`, `add-user`, `remove-user` и `gen-keys`
- Использует метод `restart_xray()` в классе DockerManager
- Перезапускает контейнер без полной остановки и запуска

### Генерация ключей
- Предпочтительно использует Docker-команду `xray x25519`
- Имеет запасной вариант с использованием Python

### Обновление конфигурации
- Поддерживает частичное обновление параметров
- Автоматически обновляет как конфигурацию, так и метаданные
- Создает новую конфигурацию, если файл не существует

### QR-коды и конфигурации
- Может отображать QR-коды в виде ASCII в терминале
- Может сохранять QR-коды в файлы PNG
- Может выводить только JSON-конфигурацию без QR-кода
- Может сохранять JSON-конфигурацию в файл
- Генерирует URI-ссылки VLESS формата `vless://UUID@SERVER:PORT?параметры#название`
- Создает QR-коды на основе URI-ссылок VLESS
- Автоматически определяет внешний IP-адрес сервера с помощью внешних API

### Ограничения
- Использует только стандартные библиотеки Python и библиотеку для QR-кодов
- Для работы требуется Docker
- Автоматическое определение IP может не работать за NAT или прокси

## Недавно внесенные изменения
- **Добавлены индивидуальные shortId для каждого пользователя**
- **Добавлено удаление shortId при удалении пользователя**
- **Реализован автоматический перезапуск сервера после изменения конфигурации (флаг `--restart`)**

## Заметки по дальнейшей разработке
- Возможна реализация нативной поддержки X25519 без Docker
- Можно добавить функциональность для мониторинга состояния Xray
- Добавить шаблоны конфигураций для разных сценариев
- Разработать веб-интерфейс для управления
